<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Unit test in Johnny-Five nodebot apps</title>
  <meta name="description" content="This is my blog, where i talk about technologies" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="http://willmendesneto.github.io/2016/06/27/unit-test-in-johnny-five-nodebot-apps">

  
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="cache-control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-store, no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="CACHE-CONTROL" content="NO-CACHE" />
    <meta http-equiv="PRAGMA" content="NO-CACHE" />
    <meta name="domain" content="willmendesneto.github.io" />
    <meta name="url" content="/2016/06/27/unit-test-in-johnny-five-nodebot-apps" />

    <meta property="og:type" content="article" />
    <meta property="og:title" content="Unit test in Johnny-Five nodebot apps" />
    <meta property="og:url" content="/2016/06/27/unit-test-in-johnny-five-nodebot-apps" />
    <meta property="og:description" content="" />
    <meta property="article:author" content="" />
    <meta property="og:site_name" content="Wilson Mendes - Blog" />
    <meta property="og:image" content="/assets/images/nodebots-unit-test.png" />
    <meta name="twitter:site" content="@willmendesneto" />
    <meta name="twitter:image" content="/assets/images/nodebots-unit-test.png" />
    <meta name="twitter:card" content="summary" />
    <meta name="autor" content="Wilson Mendes" />
    <meta name="reply-to" content="willmendesneto@gmail.com">
    <meta name="revisit-after" content="3" />
    <meta name="title" content="Wilson Mendes - Blog">
    <meta name="description" content="This is my blog, where i talk about technologies">
    <meta name="keywords" content="["frontend",, "nodebots",, "nodejs"]" />
  

  <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Pesquisa no Blog" />

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--  <link rel="stylesheet" href=""> -->
  <!-- <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i"> -->
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800" rel="stylesheet" type="text/css">

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/solarized-dark.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/assets/css/print.css" />
</head>

  <body itemscope itemtype="http://schema.org/Article" id="body-content">
    <!-- header start -->

<!-- <a href="http://willmendesneto.github.io" class="logo-readium"><span class="logo" style="background-image: url()"></span></a> -->

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="article-image">
          <div class="post-image-image" style="background-image: url(/assets/images/nodebots-unit-test.png)">
            Article Image
          </div>
          <div class="post-meta">
            <h1 class="post-title">Unit test in Johnny-Five nodebot apps</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(https://pt.gravatar.com/userimage/20307137/677413a79461cdfd62c8a65143214850.png?size=300)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person">Wilson Mendes</h4>
              on
              <time datetime="2016-06-27 00:00">27 Jun 2016</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
            <div style="text-align:center">
              <a href="#topofpage" class="topofpage"><i class="fa fa-angle-down"></i></a>
            </div>
          </div>
        </div>
        
        <section class="post-content">

          <a class="home-button"  href="/">&laquo; Home</a>
          <div class="post-reading">
            Lido a <span class="post-reading-time"></span>
          </div>
          <a name="topofpage"></a>
          <div id="post-content-page">
            <h1 id="intro">Intro</h1>

<p>This time something simple, but without good information about it is how to add unit tests in Nodebots apps.</p>

<blockquote>
  <p>Unit test? But this is not a new thing</p>
</blockquote>

<p>Yes, you’re right, but you can find few contents about this topic in arduino, robots and open hardware apps.</p>

<p>But relax … this is not a big deal ;)</p>

<h1 id="unit-tests">Unit tests</h1>

<p>Unit test is only one way to test your software. Based in the <a href="http://martinfowler.com/bliki/TestPyramid.html">test pyramid</a> this is the way that you can organize the tests your application.</p>

<p><img src="/assets/images/pyramid.png" alt="Pyramid tests" /></p>

<blockquote>
  <p>In this post we will talk only of unit tests, if you like to know more about all the layers, please read <a href="http://martinfowler.com/bliki/TestPyramid.html">“TestPyramid” post of Martin Fowler</a></p>
</blockquote>

<p>The idea of the unit test is validate your code, make sure that your code is doing what it suppose to do and give you feedback about the errors fast (before your deploy pipeline steps) when the assertion fails.</p>

<p>The validation of this concept was in the <a href="https://github.com/willmendesneto/build-checker">Build Checker repository</a> and was really easy.</p>

<blockquote>
  <p>If you like to know more about the project, please read
<a href="/2016/05/15/checking-your-build-in-snap-ci-via-nodebots-using-nodejs-and-arduino">“Checking your build in SNAP-CI via nodebots using NodeJS and Arduino”</a></p>
</blockquote>

<h1 id="what-about-nodebots">What about nodebots?</h1>

<p>One aspect that nobody explain very well is about the tests in nodebots. The main goal in this case is create the electric mocks and stubs and simulate the communication between components.</p>

<p>One useful package is <a href="https://github.com/rwaldron/mock-firmata">mock-firmata</a>, created by Rick Waldron to make the tests in <a href="http://johnny-five.io">Johnny-Five</a> easier. The integration is really simple, you just need to load and create your board component in the test.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">require</span><span class="p">(</span><span class="s1">'should'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mockFirmata</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mock-firmata'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">five</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'johnny-five'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Board</span> <span class="o">=</span> <span class="nx">five</span><span class="p">.</span><span class="nx">Board</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Accelerometer</span> <span class="o">=</span> <span class="nx">five</span><span class="p">.</span><span class="nx">Accelerometer</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Board</span><span class="p">({</span>
  <span class="na">io</span><span class="p">:</span> <span class="k">new</span> <span class="nx">mockFirmata</span><span class="p">.</span><span class="nx">Firmata</span><span class="p">(),</span>
  <span class="na">debug</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">repl</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">});</span>
</code></pre>
</div>

<p>After the integration, the unit tests is using mocha test framework (but you can use others, if you like), <a href="http://sinonjs.org/">sinon js</a> in test spies, stubs and mocks and <a href="https://shouldjs.github.io/">should js</a>  for the assertions.</p>

<p>One simple way to validation is when the build checker should blink the led. Basically you have to create a stub for the request (in this case using <a href="https://github.com/request/request">request package</a>) for validate the response by expected types (<code class="highlighter-rouge">success</code> and <code class="highlighter-rouge">error</code>) and spy the led components.</p>

<p>After this is create the scenario for validate this case. Nothing really hard, right? Some things that you need to remember about the test is that your <code class="highlighter-rouge">beforeEach</code> method should be a documentation about the steps to reproduce your scenario.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">require</span><span class="p">(</span><span class="s1">'should'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'request'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">sinon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'sinon'</span><span class="p">);</span>

<span class="p">...</span>
<span class="nx">describe</span><span class="p">(</span><span class="s1">'When the CI server send success response'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">successResponseCI</span> <span class="o">=</span> <span class="err">`</span><span class="nx">your</span> <span class="nx">awesome</span> <span class="nx">response</span><span class="err">`</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">clock</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">useFakeTimers</span><span class="p">();</span>
    <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="s1">'get'</span><span class="p">).</span><span class="nx">yields</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">successResponseCI</span><span class="p">);</span>
    <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">(</span><span class="nx">buildChecker</span><span class="p">.</span><span class="nx">ledSuccess</span><span class="p">,</span> <span class="s1">'on'</span><span class="p">);</span>
    <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">(</span><span class="nx">buildChecker</span><span class="p">.</span><span class="nx">ledError</span><span class="p">,</span> <span class="s1">'off'</span><span class="p">);</span>

    <span class="nx">buildChecker</span><span class="p">.</span><span class="nx">startPolling</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nx">tick</span><span class="p">(</span><span class="nx">CONFIG</span><span class="p">.</span><span class="nx">INTERVAL</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should turn on the success led'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">buildChecker</span><span class="p">.</span><span class="nx">ledSuccess</span><span class="p">.</span><span class="nx">on</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should turn off the error led'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">buildChecker</span><span class="p">.</span><span class="nx">ledError</span><span class="p">.</span><span class="nx">off</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
  <span class="p">});</span>

<span class="p">});</span>
<span class="p">...</span>
</code></pre>
</div>

<p>After this you can add more tests and create your pipeline correctly, so you are sure that your code is covered. The final result is :</p>

<p><img src="/assets/images/build-checker-code-coverage.png" alt="Build Checker Code Coverage" /></p>

<p>*** This don’t remove other validations, as validation with software, but it’s another way to validate first the new features, updates, etc.</p>

<h1 id="conclusion">Conclusion</h1>

<p>As you can see the integration with unit tests is really easy and you can make sure that at least these cases are covered in your app. In this repository is integrated code coverage badge, code lint and more.</p>

<p>How about you? How you are using node js and unit tests? Are you testing your node js embedded applications? Share your experience!</p>

<p>Thank you and see you soon!</p>

<p>Links:</p>

<ul>
  <li>Johnny-Five: <a href="http://johnny-five.io">http://johnny-five.io</a></li>
  <li>Test pyramid: <a href="http://martinfowler.com/bliki/TestPyramid.html">http://martinfowler.com/bliki/TestPyramid.html</a></li>
  <li>Mock Firmata: <a href="https://github.com/rwaldron/mock-firmata">https://github.com/rwaldron/mock-firmata</a></li>
  <li>Build Checker: <a href="https://github.com/willmendesneto/build-checker">https://github.com/willmendesneto/build-checker</a></li>
  <li>Sinon JS: <a href="http://sinonjs.org/">http://sinonjs.org/</a></li>
  <li>Should JS: <a href="https://shouldjs.github.io/">https://shouldjs.github.io/</a></li>
  <li>Mocha JS: <a href="https://mochajs.org/">https://mochajs.org/</a></li>
</ul>


          </div>
        </section>

        
          <section class="newsletter-content">
    <form action="http://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open('http://feedburner.google.com/fb/a/mailverify?uri=willmendesneto', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true;" >
        <h3 class="newsletter-title">Receive news by email</h3>
        <p class="newsletter-text">Subscribe to my newsletter to receive notifications of new articles in your e- mail</p>
        <input class="input-newsletter" type="email" name="email" placeholder="email"/>
        <input type="hidden" value="willmendesneto" name="uri"/>
        <input type="hidden" name="loc" value="en_US"/>
        <input class="btn btn-newsletter" type="submit" value="Subscribe" />
    </form>
</section>

        

        <footer class="post-footer">

          <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
  <a class="addthis_button_preferred_1"></a>
  <a class="addthis_button_preferred_2"></a>
  <a class="addthis_button_preferred_3"></a>
  <a class="addthis_button_preferred_4"></a>
  <a class="addthis_button_preferred_5"></a>
</div>


          <!-- <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Unit+test+in+Johnny-Five+nodebot+apps&amp;url=http://willmendesneto.github.io/2016/06/27/unit-test-in-johnny-five-nodebot-apps"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
                <a class="icon-facebook" href="//www.facebook.com/sharer.php?t=Unit+test+in+Johnny-Five+nodebot+apps&amp;u=http://willmendesneto.github.io/2016/06/27/unit-test-in-johnny-five-nodebot-apps"
                  onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
                <i class="fa fa-facebook"></i><span class="hidden">facebook</span>
                </a>
              
            
              
            
              
                <a class="icon-google-plus" href="https://plus.google.com/share?t=Unit+test+in+Johnny-Five+nodebot+apps&amp;url=http://willmendesneto.github.io/2016/06/27/unit-test-in-johnny-five-nodebot-apps"
                  onclick="window.open(this.href, 'google-plus-share', 'width=550,height=255');return false;">
                <i class="fa fa-google-plus"></i><span class="hidden">google-plus</span>
                </a>
              
            
          </section> -->
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <section class="author">
              <div class="author-image" style="background-image: url(https://pt.gravatar.com/userimage/20307137/677413a79461cdfd62c8a65143214850.png?size=300)">Blog Logo</div>
              <h4>Wilson Mendes</h4>
              
                <p class="bio">Google Developer Expert (GDE) AngularJS and GDG Salvador Organizer. Musician and designer in his spare time.</p>
              
              <hr>
              <p class="published">Publicado em <time datetime="2016-06-27 00:00">27 Jun 2016</time></p>
            </section>
            <footer class="site-footer">
              <section class="poweredby">Mais um blog feito com <a href="http://jekyllrb.com">Jekyll</a></section>
              <a class="subscribe" href="/feed.xml" target="_blank"> <span class="tooltip"> <i class="fa fa-rss"></i> Assine o feed.</span></a>
            </footer>
          </div>
          
        </div>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'willmendesnetogithubio'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */

        'use strict';

        function load() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

          // Remove o evento
          window.onscroll = function() {};
        }

        window.onscroll = function() {
          if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 2000)) {
            load();
          }
        };
        </script>

        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </article>

    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/background-1.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Wilson Mendes - Blog</h1>
        <h2 class="blog-description">This is my blog, where i talk about technologies</h2>
        <a href="/" class="btn">Back to Home</a>
      </div>
    </div>

    
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53c591e4471ce379" async="async"></script>

<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="https://hammerjs.github.io/dist/hammer.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-58169656-1', 'auto');
ga('send', 'pageview');

(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    $window.on('scroll', function() {
      var top = $window.scrollTop();

      if (top < 0 || top > 1500) { return; }
      $image
        .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
        .css('opacity', 1-Math.max(top/700, 0));
    });
    $window.trigger('scroll');

    var height = $('.article-image').height();
    $('.post-content').css('padding-top', height + 'px');

    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
       && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({ scrollTop: target.offset().top }, 500);
          return false;
        }
      }
    });
  });
}(jQuery));
</script>

  </body>
</html>
